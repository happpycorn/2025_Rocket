<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Rocket Monitor</title>
  <script src="https://unpkg.com/vue@3.4.15/dist/vue.global.prod.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body { font-family: Arial; margin: 0; padding: 20px; }
    .grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
    .box { border: 1px solid #ccc; padding: 15px; border-radius: 8px; }
    .status-item { display: flex; align-items: center; margin-bottom: 8px; }
    .status-color { width: 14px; height: 14px; border-radius: 3px; margin-right: 8px; }
    #map { height: 300px; }
  </style>
</head>
<body>
  <div id="app">
    <div class="grid">
      <!-- Current Status -->
      <div class="box">
        <h2>Current Status</h2>
        <div v-for="item in statusList" :key="item.label" class="status-item">
          <div class="status-color" :style="{ backgroundColor: item.color }"></div>
          <div>{{ item.label }}: {{ item.value }}</div>
        </div>
      </div>

      <!-- Warning Alert -->
      <div class="box" style="background-color: #f35d5d; text-align: center;">
        <h2>Warning Alert</h2>
        <p >{{ warningMessage }}</p>
      </div>

      <!-- Rocket Location -->
      <div class="box">
        <h2>Rocketâ€™s Location</h2>
        <div id="map"></div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
  const { createApp, ref, onMounted } = Vue;

  createApp({
    setup() {
      const statusList = ref([]);
      const locations = ref([]);
      const warningMessage = ref("Loading...");
      let map = null;
      let markers = [];

      function evaluateWarning(data) {
        const errors = [];

        data.forEach(item => {
          const label = item.label.toLowerCase();
          if (label.includes("condition") && item.value !== "ok") {
            errors.push(`${item.label} is abnormal`);
          }
          if (label === "vertical acceleration" && Math.abs(item.value) > 20) {
            errors.push("Acceleration too high");
          }
          if (label === "lora-delayed time" && item.value > 5) {
            errors.push("Lora delay too long");
          }
        });

        return errors.length > 0
          ? "âš  Warning:\n" + errors.join("\n")
          : "All seems to be normal!\nAnd Iâ€™ll keep hoping so...";
      }

      async function loadData() {
        try {
          const [statusRes, locRes] = await Promise.all([
            fetch("./data/status.json"),
            fetch("./data/locations.json")
          ]);

          const statusData = await statusRes.json();
          const locationData = await locRes.json();

          statusList.value = statusData;
          warningMessage.value = evaluateWarning(statusData);

          // æ›´æ–°åœ°åœ–
          if (!map) {
            map = L.map("map").setView(locationData[0], 16);
            L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
              attribution: "&copy; OpenStreetMap contributors"
            }).addTo(map);
          }

          // æ¸…é™¤èˆŠçš„ marker
          markers.forEach(m => map.removeLayer(m));
          markers = locationData.map(coord => L.marker(coord).addTo(map));
        } catch (err) {
          warningMessage.value = "ğŸš¨ Error loading data!";
          console.error(err);
        }
      }

      onMounted(() => {
        loadData(); // åˆæ¬¡è¼‰å…¥
        setInterval(loadData, 5000); // æ¯ 5 ç§’é‡è¼‰
      });

      return { statusList, warningMessage };
    }
  }).mount("#app");
</script>

</body>
</html>
